graph TD
UI[UI Frontend] --> GW[API Gateway]

GW --> AUTH[Auth Service]
GW --> RES[Reservation Service]

RES --> TOB[Transactional Outbox]
TOB --> SCH[Scheduler]
SCH --> ORC[Booking Orchestrator Service]

ORC --> FLIGHT[Flight Service]
ORC --> PAY[Payment Service]

FLIGHT --> KAFKA[Kafka]
KAFKA --> FQ[Flight Query Service]

KAFKA --> EDC[EventDeduplicationCache]
EDC --> FQ

%% Databases
RES --> PGRES[(PostgreSQL)]
ORC --> PGBOOK[(PostgreSQL)]
FLIGHT --> PGFLIGHT[(PostgreSQL)]
FQ --> PGQUERY[(PostgreSQL)]
PAY --> PGPAY[(PostgreSQL)]

%% Axon Server
RES --> AXON[Axon Server]
ORC --> AXON
FLIGHT --> AXON
FQ --> AXON
PAY --> AXON

%% Monitoring
RES --> OTEL[OpenTelemetry<br/>Java Agent]
ORC --> OTEL
FLIGHT --> OTEL
FQ --> OTEL
PAY --> OTEL

%% Additional monitoring
RES --> PROM[Prometheus]
ORC --> PROM
FLIGHT --> PROM
FQ --> PROM
PAY --> PROM
PROM --> GRAF[Grafana]

OTEL --> JAEGER[Jaeger]

%% Kafka UI
KAFKA --> KAFDROP[Kafdrop]

%% Saga Pattern
ORC -.->|Saga Coordination| FLIGHT
ORC -.->|Saga Coordination| PAY
ORC -.->|Saga Coordination| RES

%% Event Flow
FLIGHT -.->|Events| KAFKA
KAFKA -.->|Sync Events| FQ


